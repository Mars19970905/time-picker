<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共同有空時間比較器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .input-section {
            border: 2px solid #e0e0e0;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #fafafa;
        }

        .filled-people {
            background-color: #e8f5e8;
            border: 2px solid #4CAF50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .date-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .month-separator {
            grid-column: 1 / -1;
            text-align: center;
            font-weight: bold;
            color: #2196F3;
            background-color: #e3f2fd;
            padding: 15px;
            margin: 15px 0 10px 0;
            border-radius: 8px;
            border: 2px solid #2196F3;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .month-separator:hover {
            background-color: #bbdefb;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
        }

        .month-separator .toggle-icon {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .month-separator.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }

            .date-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 6px;
            }

            .date-option {
                padding: 8px;
                font-size: 14px;
            }

            .month-separator {
                padding: 12px;
                font-size: 16px;
            }

            button {
                padding: 8px 16px;
                font-size: 14px;
            }

            h1 {
                font-size: 24px;
            }

            h2 {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
                margin: 5px;
            }

            .date-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 4px;
            }

            .date-option {
                padding: 6px;
                font-size: 12px;
                flex-direction: column;
                text-align: center;
            }

            .date-option input[type="checkbox"] {
                margin-right: 0;
                margin-bottom: 4px;
            }

            .month-separator {
                padding: 10px;
                font-size: 14px;
            }

            button {
                padding: 6px 12px;
                font-size: 12px;
                margin: 3px;
            }

            .person-card {
                padding: 10px;
            }

            .date-tag {
                padding: 3px 6px;
                font-size: 12px;
                margin: 1px;
            }
        }

        .date-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .date-option:hover {
            border-color: #4CAF50;
            background-color: #f8fff8;
        }

        .date-option.selected {
            border-color: #4CAF50;
            background-color: #e8f5e8;
        }

        .date-option.weekend {
            background-color: #fff3e0;
            border-color: #ff9800;
        }

        .date-option.weekend:hover {
            border-color: #f57c00;
            background-color: #ffe0b2;
        }

        .date-option.weekend.selected {
            border-color: #f57c00;
            background-color: #ffcc80;
        }

        .date-option input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .weekday-label {
            font-size: 12px;
            color: #666;
            margin-left: 5px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        button:hover {
            background-color: #45a049;
        }

        .clear-btn {
            background-color: #f44336;
        }

        .clear-btn:hover {
            background-color: #da190b;
        }

        .edit-btn {
            background-color: #2196F3;
        }

        .edit-btn:hover {
            background-color: #1976D2;
        }

        .result {
            margin-top: 30px;
            padding: 20px;
            background-color: #e8f5e8;
            border-radius: 8px;
            border-left: 5px solid #4CAF50;
        }

        .no-result {
            background-color: #ffe8e8;
            border-left-color: #f44336;
        }

        .people-list {
            margin-bottom: 20px;
        }

        .person-card {
            background-color: #f0f8ff;
            border: 1px solid #87ceeb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .person-name {
            font-weight: bold;
            color: #2c5282;
            margin-bottom: 8px;
        }

        .date-tag {
            display: inline-block;
            background-color: #2196F3;
            color: white;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 15px;
            font-size: 14px;
        }

        .common-date {
            background-color: #4CAF50;
            font-weight: bold;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }

        .edit-mode {
            background-color: #fff3e0;
            border: 2px solid #ff9800;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>🗓️ 共同有空時間比較器</h1>

        <!-- 填寫區域 -->
        <div class="input-section">
            <h2>📝 填寫您的有空時間</h2>
            <div class="form-group">
                <label>姓名:</label>
                <input type="text" id="person-name" placeholder="請輸入您的姓名">
            </div>
            <div class="form-group">
                <label>選擇您有空的日期 (10月-11月): <span class="weekday-label">🟠 週末 📅 平日</span></label>
                <div style="margin-bottom: 10px;">
                    <button type="button" onclick="toggleAllMonths(true)" style="background-color: #4CAF50; font-size: 12px; padding: 5px 10px;">📂 全部展開</button>
                    <button type="button" onclick="toggleAllMonths(false)" style="background-color: #ff9800; font-size: 12px; padding: 5px 10px;">📁 全部收合</button>
                </div>
                <div class="date-grid" id="date-grid"></div>
            </div>
            <button onclick="submitPerson()">✅ 提交我的有空時間</button>
            <button class="clear-btn" onclick="clearMyInput()">🔄 重新填寫</button>
        </div>

        <!-- 已填寫人員列表 -->
        <div class="people-list">
            <h2>👥 已填寫人員 (<span id="people-count">0</span>人)</h2>
            <div id="filled-people"></div>
        </div>

        <!-- 控制按鈕 -->
        <div style="text-align: center;">
            <button onclick="compareCommonDates()">🔍 手動重新計算</button>
            <button class="clear-btn" onclick="clearAll()">🗑️ 清除全部資料</button>
        </div>

        <!-- 結果顯示 -->
        <div id="result"></div>
    </div>

    <script>
        let filledPeople = [];

        // 從 localStorage 載入資料
        function loadDataFromStorage() {
            const savedData = localStorage.getItem('filledPeople');
            if (savedData) {
                try {
                    filledPeople = JSON.parse(savedData);
                } catch (error) {
                    console.error('載入資料失敗:', error);
                    filledPeople = [];
                }
            }
        }

        // 將資料保存到 localStorage
        function saveDataToStorage() {
            try {
                localStorage.setItem('filledPeople', JSON.stringify(filledPeople));
            } catch (error) {
                console.error('保存資料失敗:', error);
            }
        }

        // 生成10月和11月的所有日期
        function generateOctoberAndNovemberDates() {
            const year = new Date().getFullYear();
            const allDates = [];

            // 10月有31天
            for (let day = 1; day <= 31; day++) {
                const date = new Date(year, 9, day); // 9代表10月 (0-based)
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];

                // 週名對應
                const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
                const weekdayName = weekdays[dayOfWeek];

                // 判斷是否為週末
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                allDates.push({
                    date: dateStr,
                    display: `${year}/10/${day.toString().padStart(2, '0')} (${weekdayName})`,
                    isWeekend: isWeekend,
                    dayOfWeek: dayOfWeek,
                    month: 10 // 直接標記月份
                });
            }

            // 11月有30天
            for (let day = 1; day <= 30; day++) {
                const date = new Date(year, 10, day); // 10代表11月 (0-based)
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];

                // 週名對應
                const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
                const weekdayName = weekdays[dayOfWeek];

                // 判斷是否為週末
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                allDates.push({
                    date: dateStr,
                    display: `${year}/11/${day.toString().padStart(2, '0')} (${weekdayName})`,
                    isWeekend: isWeekend,
                    dayOfWeek: dayOfWeek,
                    month: 11 // 直接標記月份
                });
            }

            return allDates;
        }

        // 初始化日期選項
        function initializeDateOptions() {
            const dateGrid = document.getElementById('date-grid');
            const allDates = generateOctoberAndNovemberDates();

            let currentMonth = null;

            allDates.forEach(dateInfo => {
                // 檢查是否需要加入月份分隔線
                const dateMonth = dateInfo.month; // 直接使用標記的月份
                if (currentMonth !== dateMonth) {
                    currentMonth = dateMonth;
                    
                    // 創建月份分隔線
                    const monthSeparator = document.createElement('div');
                    monthSeparator.className = 'month-separator';
                    monthSeparator.dataset.month = dateMonth;
                    monthSeparator.innerHTML = `
                        <span>📅 ${dateMonth}月</span>
                        <span class="toggle-icon">🔽</span>
                    `;
                    
                    // 添加點擊事件來切換展開/收合
                    monthSeparator.addEventListener('click', function() {
                        const month = this.dataset.month;
                        const dateOptions = document.querySelectorAll(`.date-option[data-month="${month}"]`);
                        const isCollapsed = this.classList.contains('collapsed');
                        
                        if (isCollapsed) {
                            // 展開
                            dateOptions.forEach(option => option.style.display = 'flex');
                            this.classList.remove('collapsed');
                            this.querySelector('.toggle-icon').textContent = '🔽';
                            saveMonthState(month, true);
                        } else {
                            // 收合
                            dateOptions.forEach(option => option.style.display = 'none');
                            this.classList.add('collapsed');
                            this.querySelector('.toggle-icon').textContent = '▶️';
                            saveMonthState(month, false);
                        }
                    });
                    
                    dateGrid.appendChild(monthSeparator);
                    
                    // 載入保存的展開狀態
                    const savedState = loadMonthState(dateMonth);
                    if (savedState === false) {
                        monthSeparator.classList.add('collapsed');
                        monthSeparator.querySelector('.toggle-icon').textContent = '▶️';
                    }
                }

                const dateOption = document.createElement('div');
                dateOption.className = `date-option ${dateInfo.isWeekend ? 'weekend' : ''}`;
                dateOption.dataset.month = dateInfo.month; // 添加月份標記

                dateOption.innerHTML = `
                    <input type="checkbox" id="date-${dateInfo.date}" value="${dateInfo.date}">
                    <label for="date-${dateInfo.date}">
                        ${dateInfo.display}
                        ${dateInfo.isWeekend ? '🟠' : '📅'}
                    </label>
                `;

                dateOption.addEventListener('click', function (e) {
                    if (e.target.tagName !== 'INPUT') {
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                    }
                    this.classList.toggle('selected', this.querySelector('input[type="checkbox"]').checked);
                });

                // 檢查是否需要隱藏（如果該月份是收合狀態）
                const savedState = loadMonthState(dateInfo.month);
                if (savedState === false) {
                    dateOption.style.display = 'none';
                }

                dateGrid.appendChild(dateOption);
            });
        }

        // 保存月份展開狀態
        function saveMonthState(month, isExpanded) {
            try {
                const monthStates = JSON.parse(localStorage.getItem('monthStates') || '{}');
                monthStates[month] = isExpanded;
                localStorage.setItem('monthStates', JSON.stringify(monthStates));
            } catch (error) {
                console.error('保存月份狀態失敗:', error);
            }
        }

        // 載入月份展開狀態
        function loadMonthState(month) {
            try {
                const monthStates = JSON.parse(localStorage.getItem('monthStates') || '{}');
                return monthStates[month] !== undefined ? monthStates[month] : true; // 預設展開
            } catch (error) {
                console.error('載入月份狀態失敗:', error);
                return true; // 預設展開
            }
        }

        // 切換所有月份的展開/收合狀態
        function toggleAllMonths(expand) {
            const monthSeparators = document.querySelectorAll('.month-separator');
            
            monthSeparators.forEach(separator => {
                const month = separator.dataset.month;
                const dateOptions = document.querySelectorAll(`.date-option[data-month="${month}"]`);
                
                if (expand) {
                    // 展開
                    dateOptions.forEach(option => option.style.display = 'flex');
                    separator.classList.remove('collapsed');
                    separator.querySelector('.toggle-icon').textContent = '🔽';
                } else {
                    // 收合
                    dateOptions.forEach(option => option.style.display = 'none');
                    separator.classList.add('collapsed');
                    separator.querySelector('.toggle-icon').textContent = '▶️';
                }
                
                // 保存狀態
                saveMonthState(month, expand);
            });
        }

        // 提交個人資料
        function submitPerson() {
            const name = document.getElementById('person-name').value.trim();
            if (!name) {
                alert('請輸入您的姓名');
                return;
            }

            // 檢查是否已經填寫過（但這次不自動覆蓋，而是提醒）
            const existingPersonIndex = filledPeople.findIndex(person => person.name === name);
            if (existingPersonIndex !== -1) {
                if (!confirm('這個姓名已經存在，是否要更新資料？')) {
                    return;
                }
                // 移除舊資料
                filledPeople.splice(existingPersonIndex, 1);
            }

            const selectedDates = [];
            const checkboxes = document.querySelectorAll('#date-grid input[type="checkbox"]:checked');

            if (checkboxes.length === 0) {
                alert('請至少選擇一個有空的日期');
                return;
            }

            checkboxes.forEach(checkbox => {
                selectedDates.push(checkbox.value);
            });

            filledPeople.push({
                name: name,
                availableDates: selectedDates
            });

            saveDataToStorage(); // 保存到 localStorage
            updateFilledPeopleDisplay();
            clearMyInput();
            alert(`${name} 的有空時間已記錄！`);

            // 自動顯示共同時間
            autoDisplayCommonDates();
        }

        // 更新已填寫人員顯示
        function updateFilledPeopleDisplay() {
            const filledPeopleDiv = document.getElementById('filled-people');
            const countSpan = document.getElementById('people-count');

            countSpan.textContent = filledPeople.length;

            if (filledPeople.length === 0) {
                filledPeopleDiv.innerHTML = '<p style="color: #666; text-align: center;">尚無人填寫</p>';
                return;
            }

            let html = '';
            filledPeople.forEach((person, index) => {
                html += `
                    <div class="person-card">
                        <div class="person-name">${person.name}</div>
                        <div>有空日期: `;

                person.availableDates.sort().forEach(date => {
                    const dateObj = new Date(date);
                    const month = dateObj.getMonth() + 1;
                    const day = dateObj.getDate();
                    const weekday = ['日', '一', '二', '三', '四', '五', '六'][dateObj.getDay()];
                    html += `<span class="date-tag">${month}/${day} (週${weekday})</span>`;
                });

                html += `</div>
                        <div style="margin-top: 10px;">
                            <button class="edit-btn" onclick="editPerson(${index})" style="margin-right: 5px;">✏️ 修改</button>
                            <button class="clear-btn" onclick="removePerson(${index})">🗑️ 移除</button>
                        </div>
                    </div>
                `;
            });

            filledPeopleDiv.innerHTML = html;
        }

        // 修改人員資料
        function editPerson(index) {
            const person = filledPeople[index];

            // 確認是否要修改
            if (!confirm(`要修改 ${person.name} 的資料嗎？`)) {
                return;
            }

            // 將資料載入到表單中
            document.getElementById('person-name').value = person.name;

            // 清除所有選擇
            clearMyInput();

            // 重新設定姓名
            document.getElementById('person-name').value = person.name;

            // 勾選該人員原本選擇的日期
            person.availableDates.forEach(date => {
                const checkbox = document.getElementById(`date-${date}`);
                if (checkbox) {
                    checkbox.checked = true;
                    checkbox.closest('.date-option').classList.add('selected');
                }
            });

            // 先移除原本的資料
            filledPeople.splice(index, 1);
            saveDataToStorage();
            updateFilledPeopleDisplay();
            autoDisplayCommonDates();

            // 滾動到填寫區域
            document.querySelector('.input-section').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });

            // 提示使用者
            alert(`${person.name} 的資料已載入到編輯區域，請修改後重新提交！`);
        }

        // 移除指定人員
        function removePerson(index) {
            const person = filledPeople[index];
            if (confirm(`確定要移除 ${person.name} 的資料嗎？`)) {
                filledPeople.splice(index, 1);
                saveDataToStorage(); // 保存到 localStorage
                updateFilledPeopleDisplay();

                // 自動更新共同時間顯示
                autoDisplayCommonDates();
            }
        }

        // 清除我的輸入
        function clearMyInput() {
            document.getElementById('person-name').value = '';
            const checkboxes = document.querySelectorAll('#date-grid input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.date-option').classList.remove('selected');
            });
        }

        // 清除全部資料
        function clearAll() {
            alert('屁眼');
            // if (confirm('確定要清除所有人的資料嗎？')) {
            //     filledPeople = [];
            //     saveDataToStorage(); // 清除 localStorage
            //     updateFilledPeopleDisplay();
            //     clearMyInput();
            //     document.getElementById('result').innerHTML = '';
            // }
        }

        // 自動顯示共同時間（不需要手動點擊按鈕）
        function autoDisplayCommonDates() {
            if (filledPeople.length === 0) {
                document.getElementById('result').innerHTML = '';
                return;
            }

            if (filledPeople.length === 1) {
                // 只有一個人時顯示提示
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = `
                    <div class="status">
                        <h3>📋 目前狀況</h3>
                        <p>已有 <strong>1</strong> 人填寫，等待更多人加入比較共同時間...</p>
                    </div>
                `;
                return;
            }

            // 找出共同日期
            let commonDates = new Set(filledPeople[0].availableDates);

            for (let i = 1; i < filledPeople.length; i++) {
                const personDates = new Set(filledPeople[i].availableDates);
                commonDates = new Set([...commonDates].filter(date => personDates.has(date)));
            }

            displayResult(Array.from(commonDates).sort());
        }

        // 比較共同有空時間（保留手動按鈕功能）
        function compareCommonDates() {
            autoDisplayCommonDates();
        }

        // 顯示結果
        function displayResult(commonDates) {
            const resultDiv = document.getElementById('result');

            let html = '<h2>📊 即時結果分析</h2>';

            // 顯示統計資訊
            html += `<div class="status">
                <p>目前已有 <strong>${filledPeople.length}</strong> 人填寫有空時間</p>
            </div>`;

            // 顯示每個人的有空日期
            html += '<h3>👥 各人有空日期:</h3>';
            filledPeople.forEach(person => {
                html += `<p><strong>${person.name}:</strong> `;
                person.availableDates.sort().forEach(date => {
                    const isCommon = commonDates.includes(date);
                    const dateObj = new Date(date);
                    const month = dateObj.getMonth() + 1;
                    const day = dateObj.getDate();
                    const weekday = ['日', '一', '二', '三', '四', '五', '六'][dateObj.getDay()];
                    html += `<span class="date-tag ${isCommon ? 'common-date' : ''}">${month}/${day} (週${weekday})</span>`;
                });
                html += '</p>';
            });

            // 顯示共同有空日期
            html += '<h3>🎯 共同有空日期:</h3>';

            if (commonDates.length > 0) {
                html += '<div class="result">';
                html += `<p><strong>🎉 太好了！找到 ${commonDates.length} 個大家都有空的日期:</strong></p>`;
                commonDates.forEach(date => {
                    const dateObj = new Date(date);
                    const month = dateObj.getMonth() + 1;
                    const day = dateObj.getDate();
                    const weekday = ['日', '一', '二', '三', '四', '五', '六'][dateObj.getDay()];
                    html += `<span class="date-tag common-date">${month}/${day} (週${weekday})</span>`;
                });
                html += '<p style="margin-top: 15px; color: #2e7d32; font-weight: bold;">✅ 可以開始規劃行程囉！</p>';
                html += '</div>';
            } else {
                html += '<div class="result no-result">';
                html += '<p><strong>😔 目前還沒有找到大家都有空的共同時間</strong></p>';
                html += '</div>';
            }

            // 顯示各日期統計
            if (filledPeople.length >= 2) {
                html += '<h3>📈 各日期統計:</h3>';
                const dateStats = {};

                filledPeople.forEach(person => {
                    person.availableDates.forEach(date => {
                        if (!dateStats[date]) {
                            dateStats[date] = [];
                        }
                        dateStats[date].push(person.name);
                    });
                });

                const sortedDates = Object.keys(dateStats).sort();
                html += '<div style="margin-top: 10px;">';

                sortedDates.forEach(date => {
                    const dateObj = new Date(date);
                    const month = dateObj.getMonth() + 1;
                    const day = dateObj.getDate();
                    const weekday = ['日', '一', '二', '三', '四', '五', '六'][dateObj.getDay()];
                    const count = dateStats[date].length;
                    const percentage = Math.round((count / filledPeople.length) * 100);
                    const isCommon = count === filledPeople.length;

                    html += `
                        <div style="margin: 5px 0; padding: 8px; background: ${isCommon ? '#e8f5e8' : '#f5f5f5'}; border-radius: 5px; border-left: 4px solid ${isCommon ? '#4CAF50' : '#ddd'};">
                            <strong>${month}/${day} (週${weekday})</strong> - 
                            ${count}/${filledPeople.length} 人有空 (${percentage}%)
                            <br><small style="color: #666;">有空的人: ${dateStats[date].join(', ')}</small>
                        </div>
                    `;
                });

                html += '</div>';
            }

            resultDiv.innerHTML = html;
        }

        // 頁面載入時初始化
        window.onload = function () {
            loadDataFromStorage(); // 載入儲存的資料
            initializeDateOptions();
            updateFilledPeopleDisplay();

            // 載入時也自動顯示共同時間
            autoDisplayCommonDates();
        };
    </script>
</body>

</html>